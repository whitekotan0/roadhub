<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoadMap Community</title>
  <style>
    :root {
      --bg-color: #0f172a;
      --node-bg: #1e293b;
      --node-border: #334155;
      --node-hover: #3b82f6;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --line-color: #475569;
      --completed-bg: #065f46;
      --completed-border: #10b981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- Toolbar (Left) --- */
    #toolbar {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(8px);
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid var(--node-border);
      display: flex;
      gap: 15px;
      align-items: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    /* --- Stats Panel (Right) --- */
    #stats-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(8px);
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid var(--node-border);
      text-align: right;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    .stats-value { font-size: 20px; font-weight: bold; color: #10b981; }
    .stats-label { font-size: 12px; color: #94a3b8; }

    h1 { font-size: 18px; font-weight: 700; color: #60a5fa; margin: 0; }

    button {
      background: #334155;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }
    button:hover { background: #475569; }
    button.danger:hover { background: #ef4444; }

    /* --- Canvas --- */
    #canvas-container { width: 100%; height: 100%; cursor: grab; }
    #canvas-container:active { cursor: grabbing; }

    /* --- D3 Styles --- */
    .node rect {
      fill: var(--node-bg);
      stroke: var(--node-border);
      stroke-width: 2px;
      rx: 6;
      transition: all 0.3s ease;
    }
    .node:hover rect { stroke: var(--node-hover); filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5)); }
    .node.completed rect { fill: var(--completed-bg); stroke: var(--completed-border); }
    
    .node text {
      fill: var(--text-main);
      font-size: 14px;
      font-weight: 500;
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: middle;
    }

    .link {
      fill: none;
      stroke: var(--line-color);
      stroke-width: 2px;
      transition: stroke 0.3s;
    }

    /* --- Side Panel --- */
    #panel {
      position: fixed;
      top: 0; right: -400px;
      width: 350px; height: 100%;
      background: #1e293b;
      border-left: 1px solid #334155;
      padding: 30px;
      transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 200;
      box-shadow: -5px 0 25px rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    #panel.active { right: 0; }
    #panel h2 { margin-bottom: 10px; font-size: 24px; }
    #panel .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #334155; color: #94a3b8; margin-bottom: 20px; }
    #panel p { line-height: 1.6; color: #cbd5e1; font-size: 15px; white-space: pre-line; }
    
    .close-btn { position: absolute; top: 20px; right: 20px; background: none; font-size: 24px; color: #64748b; border: none; cursor: pointer; }
    .close-btn:hover { color: white; background: none; }

    /* Loading */
    #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: #64748b; text-align: center; }
  </style>
</head>
<body>

  <div id="toolbar">
    <h1 id="map-title">Loading...</h1>
    <span style="font-size:12px; color:#64748b">|</span>
    <button onclick="resetView()">Reset View</button>
    <button class="danger" onclick="clearProgress()">Reset Progress</button>
  </div>

  <div id="stats-panel">
    <div class="stats-value" id="progress-text">0 / 0</div>
    <div class="stats-label" id="progress-percent">0% Completed</div>
  </div>

  <div id="loading">Loading...</div>

  <div id="canvas-container">
    <svg id="svg"></svg>
  </div>

  <div id="panel">
    <button class="close-btn" onclick="closePanel()">Ã—</button>
    <h2 id="p-title">Title</h2>
    <span id="p-id" class="badge">ID</span>
    <p id="p-content">Content...</p>
    <br>
    <button id="p-toggle" style="width:100%; padding:12px; margin-top:20px;">Mark as Completed</button>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script>
    // --- CONFIGURATION ---
    const NODE_WIDTH = 180;
    const NODE_HEIGHT = 60;
    const LEVEL_GAP = 250;
    const SIBLING_GAP = 300;

    // --- STATE ---
    let nodesData = [];
    let linksData = [];
    // Progress stored as: { "math.json": { "node1": true }, "coding.json": { ... } }
    let progress = JSON.parse(localStorage.getItem('roadmap-progress') || '{}');
    let currentMapId = "default";
    let svg, g, zoom;

    // --- 1. LOAD DATA ---
    async function loadData() {
      // Get 'map' param from URL, default to 'math.json'
      const urlParams = new URLSearchParams(window.location.search);
      const mapFile = urlParams.get('map') || 'math.json';

      try {
        // Fetch from 'roadmaps' folder
        const response = await fetch(`./roadmaps/${mapFile}`);
        if (!response.ok) throw new Error(`Could not load roadmaps/${mapFile}`);
        
        const json = await response.json();
        
        // Set Map ID for saving progress (use ID from JSON or filename)
        currentMapId = json.id || mapFile;
        document.getElementById('map-title').textContent = json.title || "Roadmap";

        processGraph(json.nodes);
        initGraph();
        updateStats(); // Calc stats after load
        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        document.getElementById('loading').innerHTML = `Error loading <b>${mapFile}</b>.<br><br>1. Check if file is in <b>/roadmaps</b> folder.<br>2. Check console for details.<br>3. Open via Live Server.`;
        console.error(err);
      }
    }

    // --- 2. LAYOUT LOGIC ---
    function processGraph(rawNodes) {
      const nodeMap = new Map();
      rawNodes.forEach(n => nodeMap.set(n.id, { ...n, level: 0, children: [], parents: [] }));

      linksData = [];
      rawNodes.forEach(n => {
        if (n.prerequisites) {
          n.prerequisites.forEach(parentId => {
            if (nodeMap.has(parentId)) {
              linksData.push({ source: parentId, target: n.id });
              nodeMap.get(parentId).children.push(n.id);
              nodeMap.get(n.id).parents.push(parentId);
            }
          });
        }
      });

      // Calculate Y Levels
      let changed = true;
      while(changed) {
        changed = false;
        nodeMap.forEach(node => {
          if (node.parents.length > 0) {
            const maxParentLevel = Math.max(...node.parents.map(pid => nodeMap.get(pid).level));
            if (node.level < maxParentLevel + 1) {
              node.level = maxParentLevel + 1;
              changed = true;
            }
          }
        });
      }

      // Calculate X Positions
      const levels = {};
      nodeMap.forEach(node => {
        if (!levels[node.level]) levels[node.level] = [];
        levels[node.level].push(node);
      });

      nodesData = Array.from(nodeMap.values()).map(node => {
        const nodesInLevel = levels[node.level];
        const indexInLevel = nodesInLevel.indexOf(node);
        const levelWidth = nodesInLevel.length * SIBLING_GAP;
        const xOffset = indexInLevel * SIBLING_GAP - (levelWidth / 2) + (SIBLING_GAP / 2);

        return {
          ...node,
          x: xOffset,
          y: node.level * LEVEL_GAP
        };
      });
    }

    // --- 3. RENDERING ---
    function initGraph() {
      const container = document.getElementById('canvas-container');
      svg = d3.select("#svg").attr("width", "100%").attr("height", "100%");

      // Marker
      svg.append("defs").append("marker")
        .attr("id", "arrow").attr("viewBox", "0 -5 10 10")
        .attr("refX", NODE_WIDTH / 2 + 10).attr("refY", 0)
        .attr("markerWidth", 6).attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#475569");

      g = svg.append("g");

      zoom = d3.zoom().scaleExtent([0.1, 2]).on("zoom", (e) => g.attr("transform", e.transform));
      svg.call(zoom);
      
      const initialTransform = d3.zoomIdentity.translate(container.clientWidth/2, 50).scale(0.8);
      svg.call(zoom.transform, initialTransform);

      render();
    }

    function render() {
      // Links
      g.selectAll(".link").data(linksData).join("path")
        .attr("class", "link").attr("marker-end", "url(#arrow)")
        .attr("d", d => {
          const src = nodesData.find(n => n.id === d.source);
          const trg = nodesData.find(n => n.id === d.target);
          return `M${src.x},${src.y + NODE_HEIGHT/2} C${src.x},${src.y + NODE_HEIGHT/2 + 50} ${trg.x},${trg.y - NODE_HEIGHT/2 - 50} ${trg.x},${trg.y - NODE_HEIGHT/2}`;
        });

      // Nodes
      const nodes = g.selectAll(".node").data(nodesData).join("g")
        .attr("class", d => `node ${isCompleted(d.id) ? 'completed' : ''}`)
        .attr("transform", d => `translate(${d.x - NODE_WIDTH/2}, ${d.y - NODE_HEIGHT/2})`)
        .on("click", (e, d) => openPanel(d));

      nodes.append("rect").attr("width", NODE_WIDTH).attr("height", NODE_HEIGHT);
      nodes.append("text").attr("x", NODE_WIDTH/2).attr("y", NODE_HEIGHT/2)
        .text(d => d.title.length > 20 ? d.title.substring(0,18) + '...' : d.title);
    }

    // --- 4. LOGIC & STATS ---
    function isCompleted(nodeId) {
      return progress[currentMapId] && progress[currentMapId][nodeId];
    }

    function toggleNode(nodeId) {
      // Init storage object if missing
      if (!progress[currentMapId]) progress[currentMapId] = {};

      if (progress[currentMapId][nodeId]) {
        delete progress[currentMapId][nodeId];
      } else {
        progress[currentMapId][nodeId] = true;
      }

      localStorage.setItem('roadmap-progress', JSON.stringify(progress));

      // Update Visuals
      g.selectAll(".node").filter(d => d.id === nodeId)
        .classed("completed", isCompleted(nodeId));
      
      updatePanelButton(nodeId);
      updateStats();
    }

    function updateStats() {
      const total = nodesData.length;
      if (total === 0) return;
      
      const completed = nodesData.filter(n => isCompleted(n.id)).length;
      const percent = Math.round((completed / total) * 100);

      document.getElementById('progress-text').textContent = `${completed} / ${total}`;
      document.getElementById('progress-percent').textContent = `${percent}% Completed`;
    }

    // --- 5. UI HELPERS ---
    function openPanel(node) {
      document.getElementById('p-title').textContent = node.title;
      document.getElementById('p-id').textContent = node.id;
      document.getElementById('p-content').textContent = node.content;
      
      const btn = document.getElementById('p-toggle');
      // Remove old event listeners by cloning
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.onclick = () => toggleNode(node.id);
      updatePanelButton(node.id);
      
      document.getElementById('panel').classList.add('active');
    }

    function updatePanelButton(id) {
      const btn = document.getElementById('p-toggle');
      const done = isCompleted(id);
      btn.textContent = done ? "Mark as Incomplete" : "Mark as Completed";
      btn.style.background = done ? "#334155" : "#10b981";
      btn.style.color = done ? "#cbd5e1" : "#fff";
    }

    function closePanel() { document.getElementById('panel').classList.remove('active'); }
    
    function resetView() {
      const container = document.getElementById('canvas-container');
      svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(container.clientWidth/2, 50).scale(0.8));
    }

    function clearProgress() {
      if(confirm("Are you sure? This deletes progress for the CURRENT roadmap.")) {
        if(progress[currentMapId]) delete progress[currentMapId];
        localStorage.setItem('roadmap-progress', JSON.stringify(progress));
        location.reload();
      }
    }

    // START
    loadData();
  </script>
</body>
</html>